!function(){const t={"Content-Type":"application/json"},e=t=>JSON.stringify({query:t()}),a=(t,e)=>`https://database.protronic-gmbh.de/query?database=${t}&username=${e}`,i=t=>`IF NOT EXISTS (SELECT * FROM sys.tables WHERE sys.tables.name = '${t}') CREATE TABLE ${t}(identifierField NVARCHAR(MAX), identifierValue NVARCHAR(MAX));`,r=(t,e)=>`SELECT [identifierValue] FROM ${t} WHERE [identifierField] = '${e}' GROUP BY [identifierValue];`,s=(t,e,a)=>`INSERT INTO ${t} (identifierField, identifierValue) VALUES ('${e}', '${a}');`,n=(t,e,a)=>`DELETE FROM ${t} WHERE identifierField = '${e}' AND identifierValue = '${a}';`;function d(t){let e=t;for(;;){if(e=e.parentElement,"body"==e.nodeName.toLowerCase())return;if("prot-table-v3"==e.nodeName.toLowerCase()||"wc-grid-table"==e.nodeName.toLowerCase())return e}}class h extends HTMLElement{connectedCallback(){this.dataAttributes={IdentifierField:this.getAttribute("identifierfield"),IdentifierValue:this.getAttribute("identifiervalue"),Database:this.getAttribute("database")?this.getAttribute("database"):"MarkerDB",DatabaseUser:this.getAttribute("databaseuser")?this.getAttribute("databaseuser"):"wiki",DatabaseTable:this.getAttribute("databasetable")?this.getAttribute("databasetable"):"DefaultTable",IsChecked:this.hasAttribute("checked"),MarkerText:"true|false"},this.dataProperties={ParentTable:d(this),DatabaseUrl:a(this.dataAttributes.Database,this.dataAttributes.DatabaseUser),CreateTableQuery:i.bind(this,this.dataAttributes.DatabaseTable),InsertValuesQuery:s.bind(this,this.dataAttributes.DatabaseTable,this.dataAttributes.IdentifierField,this.dataAttributes.IdentifierValue),DeleteFromQuery:n.bind(this,this.dataAttributes.DatabaseTable,this.dataAttributes.IdentifierField,this.dataAttributes.IdentifierValue)},this.dataElements={CheckboxInput:document.createElement("input"),FilterTextSpan:document.createElement("span")},this.dataAttributes.IsChecked?this.setChecked(!1):this.unsetChecked(),this.setupMarkInputElement(),this.createCheckboxInput(),this.createFilterElement()}setupMarkInputElement(){this.classList.add("marker_"+this.dataAttributes.IdentifierValue)}createCheckboxInput(){this.dataElements.CheckboxInput.type="checkbox",this.dataElements.CheckboxInput.onclick=this.clickEventHandler.bind(this),this.dataAttributes.IsChecked&&this.dataElements.CheckboxInput.toggleAttribute("checked",!0),this.append(this.dataElements.CheckboxInput)}createFilterElement(){let[t,e]=this.dataAttributes.MarkerText.split("|");this.dataElements.FilterTextSpan.style.display="none",this.dataElements.FilterTextSpan.textContent=this.dataAttributes.IsChecked?t:e,this.append(this.dataElements.FilterTextSpan)}setChecked(t){let[e,a]=this.dataAttributes.MarkerText.split("|");this.dataAttributes.IsChecked=!0,this.toggleAttribute("checked",!0),this.dataElements.CheckboxInput.toggleAttribute("checked",!0),this.dataElements.CheckboxInput.checked=!0,this.dataElements.FilterTextSpan.textContent=e,t&&(document.querySelectorAll(`.table-id-${this.dataProperties.ParentTable.tableId} mark-input.marker_${this.dataAttributes.IdentifierValue.replace(/%/g,"\\%")}`).forEach(t=>t.setChecked(!1)),this.setMarkierenData(!0)),this.setMarkiertField(!0)}unsetChecked(t){let[e,a]=this.dataAttributes.MarkerText.split("|");this.dataAttributes.IsChecked=!1,this.removeAttribute("checked"),this.dataElements.CheckboxInput.removeAttribute("checked"),this.dataElements.CheckboxInput.checked=!1,this.dataElements.FilterTextSpan.textContent=a,t&&(document.querySelectorAll(`.table-id-${this.dataProperties.ParentTable.tableId} mark-input.marker_${this.dataAttributes.IdentifierValue.replace(/%/g,"\\%")}`).forEach(t=>t.unsetChecked(!1)),this.setMarkierenData(!1)),this.setMarkiertField(!1)}setMarkierenData(t){this.dataProperties.ParentTable.data=this.dataProperties.ParentTable.data.map(e=>(e[this.dataAttributes.IdentifierField]==this.dataAttributes.IdentifierValue&&(e["#markiert"]=t?"ja":"nein",e.marker=this.dataProperties.ParentTable.createMarkInput(this.dataAttributes.IdentifierField,this.dataAttributes.IdentifierValue,this.dataAttributes.DatabaseTable,this.dataAttributes.Database,this.dataAttributes.DatabaseUser,this.dataAttributes.MarkerText,t)),e))}setMarkiertField(t){let e=this.parentElement.nextElementSibling;e&&e.classList.contains("wgt-column_#markiert")&&(e.textContent=t?"ja":"nein")}createTable(){console.log(this.dataProperties.CreateTableQuery()),fetch(this.dataProperties.DatabaseUrl,{method:"POST",headers:t,body:e(this.dataProperties.CreateTableQuery)}).then(t=>t.json()).then(t=>{console.log("finished table create query.")})}clickEventHandler(a){a.preventDefault(),a.stopPropagation(),this.dataAttributes.IsChecked?(console.log(this.dataProperties.DeleteFromQuery()),fetch(this.dataProperties.DatabaseUrl,{method:"POST",headers:t,body:e(this.dataProperties.DeleteFromQuery)}).then(t=>t.json()).then(t=>{this.unsetChecked(!0)})):(console.log(this.dataProperties.InsertValuesQuery()),fetch(this.dataProperties.DatabaseUrl,{method:"POST",headers:t,body:e(this.dataProperties.InsertValuesQuery)}).then(t=>t.json()).then(t=>{this.setChecked(!0)}))}}var l={MarkInput:h,fetchSelectCheckedValues:async function(i,s,n,d){return fetch(a(i,s),{method:"POST",headers:t,body:e(r.bind(this,n,d))}).then(t=>t.json()).then(t=>t)},fetchCreateTableIfNotExists:async function(r,s,n){return fetch(a(r,s),{method:"POST",headers:t,body:e(i.bind(this,n))}).then(t=>t.json()).then(t=>t)}};let{MarkInput:u,fetchSelectCheckedValues:b,fetchCreateTableIfNotExists:o}=l;const c={name:"MarkerInputPlugin",exec:async function(t){return await this.setupMarkInputs(t)},type:"data",tableExtensions:{async setupMarkInputs(t){const e={identifierField:this.getAttribute("marker-identifierfield"),databaseTable:this.getAttribute("marker-databasetable")},a={database:this.getAttribute("marker-database")?this.getAttribute("marker-database"):"MarkerDB",databaseuser:this.getAttribute("marker-databaseuser")?this.getAttribute("marker-databaseuser"):"wiki",markerText:this.getAttribute("marker-markertext")};return Reflect.ownKeys(e).map(t=>e[t]).every(t=>null!=t)?(await o(a.database,a.databaseuser,e.databaseTable),this.generateMarkInputData(t,e,a)):t},createMarkInput(t,e,a,i,r,s,n){let d=document.createElement("mark-input");return d.setAttribute("identifierfield",t),d.setAttribute("identifiervalue",e),a&&d.setAttribute("databasetable",a),i&&d.setAttribute("database",i),r&&d.setAttribute("databaseuser",r),s&&d.setAttribute("markertext",s),n&&d.toggleAttribute("checked",n),d.outerHTML},async generateMarkInputData(t,e,a){let{identifierField:i,databaseTable:r}=e,{database:s,databaseuser:n,markerText:d}=a;return b(s,n,r,i).then(e=>t.map(t=>{let a=e.map(t=>t.identifierValue).includes(encodeURIComponent(t[i].toString()));return{marker:this.createMarkInput(i,encodeURIComponent(t[i]).toString(),r,s,n,d,a),"#markiert":a?"ja":"nein",...t}}))}}};customElements.define("mark-input",u)}();